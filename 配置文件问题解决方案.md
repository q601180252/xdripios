# 配置文件 (Provisioning Profile) 问题解决方案

## 错误信息
```
Error: Unable to find 'ACTIVE' profiles for bundleId 'com.7RV2Y67HF6.xdripswift'.
```

## 问题原因

GitHub Actions 无法找到与 Bundle ID `com.7RV2Y67HF6.xdripswift` 对应的**有效**配置文件。

可能的原因：
1. ❌ 配置文件不存在
2. ❌ 配置文件已过期
3. ❌ Bundle ID 不匹配
4. ❌ 证书已失效
5. ❌ App Store Connect API 权限不足

---

## 解决方案

### 方案一：创建配置文件（推荐）

#### 步骤 1：登录 Apple Developer Portal
1. 访问 [Apple Developer Portal](https://developer.apple.com/account)
2. 使用您的开发者账号登录

#### 步骤 2：检查/注册 Bundle ID
1. 进入 **Certificates, Identifiers & Profiles**
2. 点击 **Identifiers**
3. 查找 `com.7RV2Y67HF6.xdripswift`
   - ✅ 如果存在，继续下一步
   - ❌ 如果不存在，点击 **"+"** 创建新的 App ID：
     - **Description**: xDrip4iOS
     - **Bundle ID**: `com.7RV2Y67HF6.xdripswift`
     - **Capabilities**: 勾选需要的功能（HealthKit, Push Notifications 等）

#### 步骤 3：创建证书（如果需要）
1. 在左侧菜单选择 **Certificates**
2. 点击 **"+"** 创建新证书
3. 选择 **iOS Distribution** (App Store and Ad Hoc)
4. 上传 CSR 文件（Certificate Signing Request）
5. 下载并双击安装证书

**生成 CSR 文件**：
```bash
# macOS 使用 Keychain Access
1. 打开 Keychain Access (钥匙串访问)
2. 菜单栏: Keychain Access > Certificate Assistant > Request a Certificate from a Certificate Authority
3. 输入邮箱和名称
4. 选择 "Saved to disk"
5. 保存为 CertificateSigningRequest.certSigningRequest
```

#### 步骤 4：创建配置文件
1. 在左侧菜单选择 **Profiles**
2. 点击 **"+"** 创建新配置文件
3. 选择类型：
   - **App Store** - 用于发布到 App Store/TestFlight ✅ 推荐
   - **Ad Hoc** - 用于测试分发
4. 选择 App ID: `com.7RV2Y67HF6.xdripswift`
5. 选择证书（刚创建的 Distribution 证书）
6. 输入配置文件名称（如 `xDrip iOS App Store`）
7. 点击 **Generate** 并下载

#### 步骤 5：记录配置文件名称
下载的文件名类似：`xDrip_iOS_App_Store.mobileprovision`

配置文件名称就是您创建时输入的名称（不包括 .mobileprovision）：
```
xDrip iOS App Store
```

---

### 方案二：修改 GitHub Actions 工作流（简化）

由于配置文件管理复杂，建议修改 GitHub Actions 使用**自动代码签名**而不是手动管理配置文件。

#### 修改 `.github/workflows/build-ipa.yml`

```yaml
name: Build xDrip iOS IPA

on:
  push:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  DEVELOPER_TEAM_ID: 7RV2Y67HF6
  BUNDLE_IDENTIFIER: com.7RV2Y67HF6.xdripswift

jobs:
  build-ipa:
    runs-on: macos-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
        
    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: 3.0
        bundler-cache: true
        
    - name: Install dependencies
      run: |
        gem install bundler:2.4.19
        bundle install
        
    - name: Resolve Package Dependencies
      run: |
        xcodebuild -workspace xdrip.xcworkspace \
                   -scheme xdrip \
                   -resolvePackageDependencies
        
    # 使用 App Store Connect API 进行代码签名
    - name: Build with App Store Connect API
      env:
        APP_STORE_CONNECT_API_KEY_KEY_ID: ${{ secrets.APPSTORE_API_KEY_ID }}
        APP_STORE_CONNECT_API_KEY_ISSUER_ID: ${{ secrets.APPSTORE_ISSUER_ID }}
        APP_STORE_CONNECT_API_KEY_KEY: ${{ secrets.APPSTORE_API_PRIVATE_KEY }}
      run: |
        # 创建 API Key 文件
        mkdir -p ~/private_keys
        echo "$APP_STORE_CONNECT_API_KEY_KEY" > ~/private_keys/AuthKey_$APP_STORE_CONNECT_API_KEY_KEY_ID.p8
        
        # 构建并归档
        xcodebuild archive \
          -workspace xdrip.xcworkspace \
          -scheme xdrip \
          -configuration Release \
          -destination "generic/platform=iOS" \
          -archivePath build/xdrip.xcarchive \
          -allowProvisioningUpdates \
          -authenticationKeyPath ~/private_keys/AuthKey_$APP_STORE_CONNECT_API_KEY_KEY_ID.p8 \
          -authenticationKeyID $APP_STORE_CONNECT_API_KEY_KEY_ID \
          -authenticationKeyIssuerID $APP_STORE_CONNECT_API_KEY_ISSUER_ID \
          CODE_SIGN_STYLE=Automatic \
          DEVELOPMENT_TEAM=${{ env.DEVELOPER_TEAM_ID }}
        
        # 导出 IPA
        xcodebuild -exportArchive \
          -archivePath build/xdrip.xcarchive \
          -exportPath build/ipa \
          -exportOptionsPlist ExportOptions.plist \
          -allowProvisioningUpdates \
          -authenticationKeyPath ~/private_keys/AuthKey_$APP_STORE_CONNECT_API_KEY_KEY_ID.p8 \
          -authenticationKeyID $APP_STORE_CONNECT_API_KEY_KEY_ID \
          -authenticationKeyIssuerID $APP_STORE_CONNECT_API_KEY_ISSUER_ID
          
    - name: Upload IPA artifact
      uses: actions/upload-artifact@v4
      with:
        name: xdrip-ipa-${{ github.sha }}
        path: build/ipa/*.ipa
        retention-days: 30
```

#### 修改 `ExportOptions.plist`

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>method</key>
    <string>app-store</string>
    <key>teamID</key>
    <string>7RV2Y67HF6</string>
    <key>uploadBitcode</key>
    <false/>
    <key>uploadSymbols</key>
    <true/>
    <key>compileBitcode</key>
    <false/>
    <key>signingStyle</key>
    <string>automatic</string>
    <key>destination</key>
    <string>export</string>
</dict>
</plist>
```

---

### 方案三：使用 Fastlane Match（企业级）

适合团队协作，自动管理证书和配置文件。

#### 步骤 1：安装 Fastlane Match
```bash
bundle exec fastlane match init
```

#### 步骤 2：配置 Matchfile
```ruby
git_url("https://github.com/YOUR_USERNAME/certificates")
storage_mode("git")
type("appstore")

app_identifier(["com.7RV2Y67HF6.xdripswift"])
username("your-apple-id@example.com")
team_id("7RV2Y67HF6")
```

#### 步骤 3：生成证书和配置文件
```bash
bundle exec fastlane match appstore
```

#### 步骤 4：在 GitHub Actions 中使用
```yaml
- name: Setup certificates
  env:
    MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
  run: |
    bundle exec fastlane match appstore --readonly
```

---

## 推荐方案对比

| 方案 | 难度 | 维护成本 | 适用场景 |
|------|------|----------|----------|
| **方案一：手动创建配置文件** | ⭐⭐ | 高 | 个人项目 |
| **方案二：自动代码签名** | ⭐ | 低 | 个人/小团队 ✅ 推荐 |
| **方案三：Fastlane Match** | ⭐⭐⭐ | 中 | 团队项目 |

---

## 快速修复步骤

### 对于个人开发者（推荐）

使用**方案二**，修改为自动代码签名：

```bash
# 1. 备份当前的工作流文件
cp .github/workflows/build-ipa.yml .github/workflows/build-ipa.yml.backup

# 2. 应用新的配置（见上方方案二的完整代码）

# 3. 更新 ExportOptions.plist
# 将 signingStyle 改为 automatic

# 4. 提交更改
git add .
git commit -m "Fix: Use automatic code signing instead of manual provisioning profiles"
git push
```

### 需要的 GitHub Secrets

使用方案二只需要配置：

```
APPSTORE_API_KEY_ID       - App Store Connect API Key ID
APPSTORE_ISSUER_ID        - App Store Connect Issuer ID  
APPSTORE_API_PRIVATE_KEY  - App Store Connect API 私钥内容
```

**不再需要**：
- ❌ CERTIFICATES_P12
- ❌ CERTIFICATES_P12_PASSWORD
- ❌ PROVISIONING_PROFILE_NAME

---

## 验证步骤

1. **提交代码**
   ```bash
   git push origin main
   ```

2. **查看 GitHub Actions 日志**
   - 进入仓库的 Actions 页面
   - 查看构建日志
   - 确认代码签名成功

3. **检查输出**
   ```
   ✅ Code signing is automatic
   ✅ Provisioning profile updated automatically
   ✅ Archive created successfully
   ✅ IPA exported successfully
   ```

---

## 常见错误处理

### 错误 1: API Key 权限不足
```
Error: Forbidden
```
**解决**：确保 API Key 有 **App Manager** 或 **Developer** 权限

### 错误 2: Team ID 不匹配
```
Error: No signing identity found
```
**解决**：确认 `DEVELOPER_TEAM_ID` 设置正确

### 错误 3: Bundle ID 未注册
```
Error: No App ID found
```
**解决**：在 Apple Developer Portal 创建 App ID

---

## 总结

**最简单的解决方案**是使用**方案二：自动代码签名**，它：

✅ 不需要手动管理配置文件  
✅ 不需要手动管理证书  
✅ 使用 App Store Connect API 自动处理  
✅ 维护成本低  
✅ 错误更少  

只需要配置 App Store Connect API 的三个 Secrets 即可！

