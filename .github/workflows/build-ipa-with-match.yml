name: Build xDrip iOS IPA (with Fastlane Match)

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      build_configuration:
        description: 'Build configuration'
        required: true
        default: 'Release'
        type: choice
        options:
        - Debug
        - Release

env:
  DEVELOPER_TEAM_ID: HHZN32E89C
  BUNDLE_IDENTIFIER: com.HHZN32E89C.xdripswiftt1li23

jobs:
  build-ipa:
    runs-on: macos-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
        
    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: 3.1
        bundler-cache: true
        
    - name: Install dependencies
      run: |
        gem install bundler:2.4.19
        bundle install
        
    - name: Resolve Package Dependencies
      run: |
        xcodebuild -workspace xdrip.xcworkspace -scheme xdrip -resolvePackageDependencies
        
    - name: Setup Fastlane Match with GitHub PAT
      env:
        MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
        MATCH_GIT_BASIC_AUTHORIZATION: ${{ secrets.MATCH_GIT_BASIC_AUTHORIZATION }}
        GH_PAT: ${{ secrets.GH_PAT }}
        GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}
        TEAMID: ${{ env.DEVELOPER_TEAM_ID }}
        FASTLANE_KEY_ID: ${{ secrets.APPSTORE_API_KEY_ID }}
        FASTLANE_ISSUER_ID: ${{ secrets.APPSTORE_ISSUER_ID }}
        FASTLANE_KEY: ${{ secrets.APPSTORE_API_PRIVATE_KEY }}
      run: |
        echo "ğŸ” é…ç½® Fastlane Match..."
        
        # è®¾ç½® Match ç¯å¢ƒå˜é‡
        echo "MATCH_PASSWORD=$MATCH_PASSWORD" >> $GITHUB_ENV
        echo "MATCH_GIT_BASIC_AUTHORIZATION=$MATCH_GIT_BASIC_AUTHORIZATION" >> $GITHUB_ENV
        echo "GH_PAT=$GH_PAT" >> $GITHUB_ENV
        echo "GITHUB_REPOSITORY_OWNER=$GITHUB_REPOSITORY_OWNER" >> $GITHUB_ENV
        echo "TEAMID=$TEAMID" >> $GITHUB_ENV
        echo "FASTLANE_KEY_ID=$FASTLANE_KEY_ID" >> $GITHUB_ENV
        echo "FASTLANE_ISSUER_ID=$FASTLANE_ISSUER_ID" >> $GITHUB_ENV
        echo "FASTLANE_KEY=$FASTLANE_KEY" >> $GITHUB_ENV
        echo "GITHUB_WORKSPACE=$GITHUB_WORKSPACE" >> $GITHUB_ENV
        
        # è®¾ç½® Match åªè¯»æ¨¡å¼(ä¸åˆ›å»ºæ–°è¯ä¹¦)
        echo "MATCH_READONLY=true" >> $GITHUB_ENV
        
        echo "âœ… Fastlane Match ç¯å¢ƒé…ç½®å®Œæˆ"
        
    - name: Download Certificates and Profiles with Fastlane Match
      env:
        MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
        GH_PAT: ${{ secrets.GH_PAT }}
        GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}
        TEAMID: ${{ env.DEVELOPER_TEAM_ID }}
      run: |
        echo "ğŸ“¥ ä½¿ç”¨ Fastlane Match ä¸‹è½½è¯ä¹¦å’Œ Provisioning Profiles..."
        
        # ä½¿ç”¨ Match ä¸‹è½½è¯ä¹¦å’Œ Profiles
        bundle exec fastlane match appstore \
          --readonly \
          --git_basic_authorization $(echo -n "$GITHUB_REPOSITORY_OWNER:$GH_PAT" | base64) \
          --app_identifier "com.$TEAMID.xdripswiftt1li23,com.$TEAMID.xdripswiftt1li23.xDripWidget,com.$TEAMID.xdripswiftt1li23.watchkitapp,com.$TEAMID.xdripswiftt1li23.watchkitapp.xDripWatchComplication,com.$TEAMID.xdripswiftt1li23.xDripNotificationContextExtension"
        
        echo "âœ… è¯ä¹¦å’Œ Provisioning Profiles å·²ä¸‹è½½"
        
    - name: Build IPA with Fastlane
      env:
        MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
        GH_PAT: ${{ secrets.GH_PAT }}
        GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}
        TEAMID: ${{ env.DEVELOPER_TEAM_ID }}
        FASTLANE_KEY_ID: ${{ secrets.APPSTORE_API_KEY_ID }}
        FASTLANE_ISSUER_ID: ${{ secrets.APPSTORE_ISSUER_ID }}
        FASTLANE_KEY: ${{ secrets.APPSTORE_API_PRIVATE_KEY }}
      run: |
        echo "ğŸ—ï¸ ä½¿ç”¨ Fastlane æ„å»º IPA..."
        
        # ä½¿ç”¨ Fastlane æ„å»º
        bundle exec fastlane build_xdrip4ios
        
        echo "âœ… IPA æ„å»ºå®Œæˆ"
          
    - name: Upload IPA artifact
      uses: actions/upload-artifact@v4
      with:
        name: xdrip-ipa-${{ github.sha }}
        path: "*.ipa"
        retention-days: 30
        
    - name: Upload dSYMs artifact
      uses: actions/upload-artifact@v4
      with:
        name: xdrip-dsyms-${{ github.sha }}
        path: "*.dSYM.zip"
        retention-days: 30
        if-no-files-found: ignore
        
    - name: Upload to TestFlight
      if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')
      env:
        FASTLANE_KEY_ID: ${{ secrets.APPSTORE_API_KEY_ID }}
        FASTLANE_ISSUER_ID: ${{ secrets.APPSTORE_ISSUER_ID }}
        FASTLANE_KEY: ${{ secrets.APPSTORE_API_PRIVATE_KEY }}
      run: |
        echo "ğŸ“¤ ä¸Šä¼ åˆ° TestFlight..."
        
        bundle exec fastlane release
        
        echo "âœ… å·²ä¸Šä¼ åˆ° TestFlight"
        
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          *.ipa
          *.dSYM.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

