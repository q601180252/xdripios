name: Verify Apple Developer Configuration

on:
  workflow_dispatch:
    inputs:
      check_type:
        description: 'æ£€æŸ¥ç±»åž‹'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - api_key
          - bundle_ids
          - provisioning_profiles
          - capabilities

env:
  DEVELOPER_TEAM_ID: HHZN32E89C
  MAIN_BUNDLE_ID: com.HHZN32E89C.xdripswiftt1li23
  APP_GROUP_ID: group.com.HHZN32E89C.loopkit.LoopGroup

jobs:
  verify-configuration:
    runs-on: macos-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup App Store Connect API Key
        env:
          API_KEY_ID: ${{ secrets.APPSTORE_API_KEY_ID }}
          API_ISSUER_ID: ${{ secrets.APPSTORE_ISSUER_ID }}
          API_PRIVATE_KEY: ${{ secrets.APPSTORE_API_PRIVATE_KEY }}
        run: |
          echo "ðŸ”§ è®¾ç½® App Store Connect API Key..."
          
          # åˆ›å»ºç›®å½•
          mkdir -p ~/.appstoreconnect/private_keys
          
          # ä¿å­˜ API Key
          echo "$API_PRIVATE_KEY" > ~/.appstoreconnect/private_keys/AuthKey_$API_KEY_ID.p8
          
          # è®¾ç½®æ–‡ä»¶æƒé™
          chmod 600 ~/.appstoreconnect/private_keys/AuthKey_$API_KEY_ID.p8
          
          echo "âœ… API Key æ–‡ä»¶å·²åˆ›å»º"

      - name: Verify API Key Permissions
        if: inputs.check_type == 'all' || inputs.check_type == 'api_key'
        env:
          API_KEY_ID: ${{ secrets.APPSTORE_API_KEY_ID }}
          API_ISSUER_ID: ${{ secrets.APPSTORE_ISSUER_ID }}
        run: |
          echo "ðŸ” éªŒè¯ API Key æƒé™..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # æ£€æŸ¥ API Key æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ -f ~/.appstoreconnect/private_keys/AuthKey_$API_KEY_ID.p8 ]; then
            echo "âœ… API Key æ–‡ä»¶å­˜åœ¨"
          else
            echo "âŒ API Key æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
          
          # å°è¯•åˆ—å‡ºåº”ç”¨
          echo ""
          echo "ðŸ“± å°è¯•è®¿é—® App Store Connect..."
          if xcrun altool --list-apps -u "dummy@example.com" --apiKey "$API_KEY_ID" --apiIssuer "$API_ISSUER_ID" 2>&1 | grep -q "NSInvalidArgumentException"; then
            echo "âš ï¸  API Key å¯èƒ½é…ç½®æ­£ç¡®ï¼Œä½†è´¦æˆ·å¯èƒ½æ²¡æœ‰åº”ç”¨æˆ–æƒé™æœ‰é™"
          else
            echo "âœ… API Key å¯ä»¥æˆåŠŸè¿žæŽ¥åˆ° App Store Connect"
          fi
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Check Bundle IDs Configuration
        if: inputs.check_type == 'all' || inputs.check_type == 'bundle_ids'
        run: |
          echo "ðŸ†” æ£€æŸ¥ Bundle ID é…ç½®..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "éœ€è¦é…ç½®çš„ Bundle IDï¼š"
          echo ""
          echo "1. ä¸»åº”ç”¨:"
          echo "   ðŸ“± ${{ env.MAIN_BUNDLE_ID }}"
          echo "   ðŸ”§ å¿…éœ€åŠŸèƒ½: App Groups, HealthKit, NFC Tag Reading"
          echo ""
          echo "2. Widget æ‰©å±•:"
          echo "   ðŸ§© ${{ env.MAIN_BUNDLE_ID }}.xDripWidget"
          echo "   ðŸ”§ å¿…éœ€åŠŸèƒ½: App Groups"
          echo ""
          echo "3. Watch App:"
          echo "   âŒš ${{ env.MAIN_BUNDLE_ID }}.watchkitapp"
          echo "   ðŸ”§ å¿…éœ€åŠŸèƒ½: App Groups"
          echo ""
          echo "4. Watch Complication:"
          echo "   âŒš ${{ env.MAIN_BUNDLE_ID }}.watchkitapp.xDripWatchComplication"
          echo "   ðŸ”§ å¿…éœ€åŠŸèƒ½: App Groups"
          echo ""
          echo "5. Notification Extension:"
          echo "   ðŸ”” ${{ env.MAIN_BUNDLE_ID }}.xDripNotificationContextExtension"
          echo "   ðŸ”§ å¿…éœ€åŠŸèƒ½: App Groups"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Verify Project Bundle IDs
        if: inputs.check_type == 'all' || inputs.check_type == 'bundle_ids'
        run: |
          echo "ðŸ” éªŒè¯é¡¹ç›®ä¸­çš„ Bundle ID é…ç½®..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # æ£€æŸ¥ xcconfig æ–‡ä»¶
          if [ -f "xDrip/xDrip.xcconfig" ]; then
            echo ""
            echo "ðŸ“„ xDrip.xcconfig é…ç½®:"
            grep "MAIN_APP_BUNDLE_IDENTIFIER" xDrip/xDrip.xcconfig || echo "âš ï¸  æœªæ‰¾åˆ° MAIN_APP_BUNDLE_IDENTIFIER"
            grep "GROUP_ID" xDrip/xDrip.xcconfig || echo "âš ï¸  æœªæ‰¾åˆ° GROUP_ID"
          fi
          
          # æ£€æŸ¥ project.pbxproj ä¸­çš„ Bundle ID
          echo ""
          echo "ðŸ“„ project.pbxproj ä¸­çš„ Bundle ID:"
          grep -o "com\.HHZN32E89C\.xdripswiftt1li23[^\"]*" xdrip.xcodeproj/project.pbxproj | sort -u | while read bundle_id; do
            echo "   âœ“ $bundle_id"
          done
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Check App Group Configuration
        if: inputs.check_type == 'all' || inputs.check_type == 'capabilities'
        run: |
          echo "ðŸ”— æ£€æŸ¥ App Group é…ç½®..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "App Group Identifier:"
          echo "   ${{ env.APP_GROUP_ID }}"
          echo ""
          echo "éœ€è¦åŒ…å«åœ¨æ­¤ App Group ä¸­çš„ Bundle ID:"
          echo "   â€¢ ${{ env.MAIN_BUNDLE_ID }}"
          echo "   â€¢ ${{ env.MAIN_BUNDLE_ID }}.xDripWidget"
          echo "   â€¢ ${{ env.MAIN_BUNDLE_ID }}.watchkitapp"
          echo "   â€¢ ${{ env.MAIN_BUNDLE_ID }}.watchkitapp.xDripWatchComplication"
          echo "   â€¢ ${{ env.MAIN_BUNDLE_ID }}.xDripNotificationContextExtension"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Check Entitlements Files
        if: inputs.check_type == 'all' || inputs.check_type == 'capabilities'
        run: |
          echo "ðŸ“œ æ£€æŸ¥ Entitlements æ–‡ä»¶..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          # æ£€æŸ¥ä¸»åº”ç”¨ entitlements
          if [ -f "xDrip/xdrip.entitlements" ]; then
            echo "âœ… xdrip.entitlements å­˜åœ¨"
            echo "   App Groups:"
            grep -A 5 "com.apple.security.application-groups" xDrip/xdrip.entitlements || echo "   âš ï¸  æœªæ‰¾åˆ° App Groups"
            echo ""
            echo "   HealthKit:"
            grep "com.apple.developer.healthkit" xDrip/xdrip.entitlements || echo "   âš ï¸  æœªæ‰¾åˆ° HealthKit"
            echo ""
            echo "   NFC:"
            grep "com.apple.developer.nfc.readersession.formats" xDrip/xdrip.entitlements || echo "   âš ï¸  æœªæ‰¾åˆ° NFC"
          else
            echo "âš ï¸  xdrip.entitlements ä¸å­˜åœ¨"
          fi
          
          # æ£€æŸ¥ Widget entitlements
          echo ""
          if [ -f "xDrip Widget Extension.entitlements" ]; then
            echo "âœ… xDrip Widget Extension.entitlements å­˜åœ¨"
          else
            echo "âš ï¸  xDrip Widget Extension.entitlements ä¸å­˜åœ¨"
          fi
          
          # æ£€æŸ¥ Watch App entitlements
          echo ""
          if [ -f "xDrip Watch App/xDrip Watch App.entitlements" ]; then
            echo "âœ… xDrip Watch App.entitlements å­˜åœ¨"
          else
            echo "âš ï¸  xDrip Watch App.entitlements ä¸å­˜åœ¨"
          fi
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Test Provisioning Profile Access
        if: inputs.check_type == 'all' || inputs.check_type == 'provisioning_profiles'
        env:
          API_KEY_ID: ${{ secrets.APPSTORE_API_KEY_ID }}
          API_ISSUER_ID: ${{ secrets.APPSTORE_ISSUER_ID }}
        run: |
          echo "ðŸ“‹ æµ‹è¯• Provisioning Profile è®¿é—®..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          # å°è¯•ä½¿ç”¨ xcodebuild çš„ allowProvisioningUpdates åŠŸèƒ½
          echo "æµ‹è¯•æ˜¯å¦å¯ä»¥è‡ªåŠ¨åˆ›å»º/æ›´æ–° Provisioning Profile..."
          echo ""
          
          # åˆ›å»ºä¸€ä¸ªç®€å•çš„æµ‹è¯•å‘½ä»¤
          xcodebuild -showBuildSettings \
            -workspace xdrip.xcworkspace \
            -scheme xdrip \
            -destination "generic/platform=iOS" \
            -authenticationKeyPath ~/.appstoreconnect/private_keys/AuthKey_$API_KEY_ID.p8 \
            -authenticationKeyID $API_KEY_ID \
            -authenticationKeyIssuerID $API_ISSUER_ID \
            | grep -i "PRODUCT_BUNDLE_IDENTIFIER\|CODE_SIGN_IDENTITY\|DEVELOPMENT_TEAM" || true
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: Generate Configuration Report
        if: always()
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ðŸ“Š é…ç½®éªŒè¯æŠ¥å‘Š"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Team ID: ${{ env.DEVELOPER_TEAM_ID }}"
          echo "Main Bundle ID: ${{ env.MAIN_BUNDLE_ID }}"
          echo "App Group: ${{ env.APP_GROUP_ID }}"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ðŸ“‹ ä¸‹ä¸€æ­¥æ“ä½œï¼š"
          echo ""
          echo "1. è®¿é—® Apple Developer Portal:"
          echo "   https://developer.apple.com/account/resources/identifiers/list"
          echo ""
          echo "2. ç¡®è®¤æ‰€æœ‰ Bundle ID å·²åˆ›å»ºå¹¶å¯ç”¨æ­£ç¡®çš„åŠŸèƒ½"
          echo ""
          echo "3. ç¡®è®¤ App Group å·²åˆ›å»ºå¹¶åŒ…å«æ‰€æœ‰ Bundle ID"
          echo ""
          echo "4. ä¸ºæ¯ä¸ª Bundle ID åˆ›å»º Provisioning Profile:"
          echo "   - Development Profile (ç”¨äºŽæµ‹è¯•)"
          echo "   - Distribution Profile (ç”¨äºŽ App Store)"
          echo ""
          echo "5. é‡æ–°è¿è¡Œæž„å»ºå·¥ä½œæµ"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          
      - name: Upload Verification Report
        if: always()
        run: |
          mkdir -p verification-reports
          
          cat > verification-reports/apple-config-report.txt << EOF
          Apple Developer Configuration Verification Report
          Generated: $(date)
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          
          Team ID: ${{ env.DEVELOPER_TEAM_ID }}
          Main Bundle ID: ${{ env.MAIN_BUNDLE_ID }}
          App Group: ${{ env.APP_GROUP_ID }}
          
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          Required Bundle IDs:
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          
          1. Main App: ${{ env.MAIN_BUNDLE_ID }}
             Capabilities: App Groups, HealthKit, NFC Tag Reading
          
          2. Widget: ${{ env.MAIN_BUNDLE_ID }}.xDripWidget
             Capabilities: App Groups
          
          3. Watch App: ${{ env.MAIN_BUNDLE_ID }}.watchkitapp
             Capabilities: App Groups
          
          4. Watch Complication: ${{ env.MAIN_BUNDLE_ID }}.watchkitapp.xDripWatchComplication
             Capabilities: App Groups
          
          5. Notification Extension: ${{ env.MAIN_BUNDLE_ID }}.xDripNotificationContextExtension
             Capabilities: App Groups
          
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          App Group Configuration:
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          
          App Group ID: ${{ env.APP_GROUP_ID }}
          
          Must include all Bundle IDs listed above.
          
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          Next Steps:
          â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
          
          1. Visit Apple Developer Portal
          2. Create/verify all Bundle IDs with required capabilities
          3. Create/verify App Group and add all Bundle IDs
          4. Create Provisioning Profiles for each Bundle ID
          5. Re-run the build workflow
          
          EOF
          
          echo "âœ… æŠ¥å‘Šå·²ç”Ÿæˆ"

      - name: Upload Report as Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: apple-configuration-verification-report
          path: verification-reports/
          retention-days: 30

