name: Initialize Fastlane Match Repository

# åªå…è®¸æ‰‹åŠ¨è§¦å‘
on:
  workflow_dispatch:

env:
  DEVELOPER_TEAM_ID: 7RV2Y67HF6
  BUNDLE_IDENTIFIER: com.7RV2Y67HF6.xdripswift

jobs:
  init-match:
    runs-on: macos-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
        
    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: 3.1
        bundler-cache: false
        
    - name: Install dependencies
      run: |
        gem install bundler
        bundle lock --update
        bundle install
        
    - name: Check if xDrip-Match-Secrets repository exists
      env:
        GH_PAT: ${{ secrets.GH_PAT }}
      run: |
        echo "ğŸ” æ£€æŸ¥ xDrip-Match-Secrets ä»“åº“æ˜¯å¦å­˜åœ¨..."
        
        RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
          -H "Authorization: token $GH_PAT" \
          https://api.github.com/repos/${{ github.repository_owner }}/xDrip-Match-Secrets)
        
        if [ "$RESPONSE" == "200" ]; then
          echo "âœ… xDrip-Match-Secrets ä»“åº“å·²å­˜åœ¨"
        elif [ "$RESPONSE" == "404" ]; then
          echo "âŒ xDrip-Match-Secrets ä»“åº“ä¸å­˜åœ¨"
          echo ""
          echo "è¯·å…ˆåˆ›å»ºä»“åº“:"
          echo "1. è®¿é—®: https://github.com/new"
          echo "2. Repository name: xDrip-Match-Secrets"
          echo "3. Visibility: Private"
          echo "4. ä¸å‹¾é€‰ä»»ä½•åˆå§‹åŒ–é€‰é¡¹"
          echo "5. Create repository"
          exit 1
        else
          echo "âŒ æ£€æŸ¥å¤±è´¥,HTTP çŠ¶æ€ç : $RESPONSE"
          echo "è¯·æ£€æŸ¥ GH_PAT æ˜¯å¦æœ‰æ•ˆ"
          exit 1
        fi
        
    - name: Initialize Match and Upload Certificates
      env:
        MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
        GH_PAT: ${{ secrets.GH_PAT }}
        GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}
        TEAMID: ${{ env.DEVELOPER_TEAM_ID }}
        GITHUB_WORKSPACE: ${{ github.workspace }}
        FASTLANE_KEY_ID: ${{ secrets.APPSTORE_API_KEY_ID }}
        FASTLANE_ISSUER_ID: ${{ secrets.APPSTORE_ISSUER_ID }}
        FASTLANE_KEY: ${{ secrets.APPSTORE_API_PRIVATE_KEY }}
      run: |
        echo "ğŸš€ åˆå§‹åŒ– Fastlane Match..."
        echo ""
        echo "ç›®æ ‡ä»“åº“: https://github.com/$GITHUB_REPOSITORY_OWNER/xDrip-Match-Secrets"
        echo "Team ID: $TEAMID"
        echo ""
        echo "å°†ä¸ºä»¥ä¸‹ 5 ä¸ª Bundle IDs åˆ›å»º Provisioning Profiles:"
        echo "  1. com.7RV2Y67HF6.xdripswift"
        echo "  2. com.7RV2Y67HF6.xdripswift.xDripWidget"
        echo "  3. com.7RV2Y67HF6.xdripswift.watchkitapp"
        echo "  4. com.7RV2Y67HF6.xdripswift.watchkitapp.xDripWatchComplication"
        echo "  5. com.7RV2Y67HF6.xdripswift.xDripNotificationContextExtension"
        echo ""
        
        # è¿è¡Œ Fastlane Match åˆå§‹åŒ–
        # ä½¿ç”¨ certs lane (ä¼šå¼ºåˆ¶åˆ›å»ºæ–°çš„ Profiles)
        bundle exec fastlane certs
        
        echo ""
        echo "âœ… Match åˆå§‹åŒ–å®Œæˆ!"
        echo ""
        echo "Match-Secrets ä»“åº“å·²æ›´æ–°,åŒ…å«:"
        echo "  âœ… Distribution è¯ä¹¦"
        echo "  âœ… 5 ä¸ª Provisioning Profiles"
        echo ""
        
    - name: Verify Match Repository
      env:
        GH_PAT: ${{ secrets.GH_PAT }}
      run: |
        echo "ğŸ” éªŒè¯ Match ä»“åº“å†…å®¹..."
        
        # å…‹éš†å¹¶æ£€æŸ¥å†…å®¹
        git clone https://$GH_PAT@github.com/${{ github.repository_owner }}/xDrip-Match-Secrets.git /tmp/match-verify
        
        echo ""
        echo "ğŸ“ Match ä»“åº“ç»“æ„:"
        cd /tmp/match-verify
        tree -L 3 || find . -type f -not -path "./.git/*"
        
        echo ""
        echo "âœ… Match ä»“åº“éªŒè¯å®Œæˆ"
        
    - name: Summary
      run: |
        echo ""
        echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
        echo "â•‘                  ğŸ‰ Match åˆå§‹åŒ–æˆåŠŸ!                                   â•‘"
        echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
        echo ""
        echo "âœ… å®Œæˆçš„æ“ä½œ:"
        echo "  1. è¿æ¥åˆ° Apple Developer Portal"
        echo "  2. ä¸‹è½½/ä½¿ç”¨ç°æœ‰çš„ Distribution è¯ä¹¦"
        echo "  3. ä¸º 5 ä¸ª Bundle IDs åˆ›å»º Provisioning Profiles"
        echo "  4. åŠ å¯†å¹¶ä¸Šä¼ åˆ° xDrip-Match-Secrets ä»“åº“"
        echo ""
        echo "ğŸ“‹ ä¸‹ä¸€æ­¥:"
        echo "  1. éªŒè¯ GitHub Secrets é…ç½®:"
        echo "     - MATCH_PASSWORD âœ…"
        echo "     - GH_PAT âœ…"
        echo "     - APPSTORE_API_KEY_ID âœ…"
        echo "     - APPSTORE_ISSUER_ID âœ…"
        echo "     - APPSTORE_API_PRIVATE_KEY âœ…"
        echo ""
        echo "  2. ä½¿ç”¨ build-ipa-with-match.yml æ„å»º:"
        echo "     è®¿é—®: https://github.com/${{ github.repository }}/actions"
        echo "     è¿è¡Œ: Build xDrip iOS IPA (with Fastlane Match)"
        echo ""
        echo "ğŸ‰ ç°åœ¨å¯ä»¥è‡ªåŠ¨æ„å»ºå’Œä¸Šä¼  TestFlight äº†!"
        echo ""

